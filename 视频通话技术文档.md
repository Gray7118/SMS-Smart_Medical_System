总结医患视频通话系统的核心技术原理，按照数据流向分层讲解：

## 1. 网络通信架构

### TCP Socket通信基础

```
客户端A ←→ 服务器 ←→ 客户端B
```

- **QTcpServer/QTcpSocket**：Qt网络模块提供可靠的TCP连接
- **消息序列化**：使用QDataStream将Message对象转为二进制流传输
- **多线程处理**：服务器为每个客户端创建独立线程(MyThread)处理请求

### 服务器转发机制

cpp

```cpp
// 核心转发逻辑
if (table.contains(msg.receiver->username)) {
    QTcpSocket *receiverSocket = table[msg.receiver->username];
    receiverSocket->write(Message::messageToByteArray(msg));
}
```

- **用户映射表**：维护username→socket的哈希表
- **消息路由**：根据接收者用户名查找对应socket进行转发

## 2. 视频数据获取

### 摄像头数据采集

bash

```bash
ffmpeg -f v4l2 -input_format mjpeg -video_size 640x480 -i /dev/video0 -f image2pipe -vcodec copy -
```

- **FFmpeg进程**：通过QProcess启动外部FFmpeg进程
- **V4L2接口**：Linux视频设备接口，直接访问摄像头
- **MJPEG格式**：摄像头原生支持，避免重编码提高效率
- **管道输出**：FFmpeg输出到标准输出管道供Qt读取

### 视频帧解析

cpp

```cpp
// JPEG帧边界检测
int start = buffer.indexOf("\xFF\xD8"); // JPEG起始标记
int end = buffer.indexOf("\xFF\xD9");   // JPEG结束标记
QByteArray jpegData = buffer.mid(start, end - start + 2);
```

- **流式解析**：从连续数据流中提取完整JPEG帧
- **缓冲区管理**：处理不完整帧，确保数据完整性

## 3. 图像处理与压缩

### 图像压缩优化

cpp

```cpp
QImage scaledImage = image.scaled(160, 120, Qt::KeepAspectRatio);
scaledImage.save(&buffer, "JPEG", 30); // 30%质量压缩
```

- **分辨率缩放**：减少传输数据量
- **JPEG压缩**：有损压缩，平衡质量与大小
- **质量参数**：30%质量足够视频通话使用

### Base64编码

cpp

```cpp
QString base64Data = imageData.toBase64();
```

- **二进制安全**：确保图像数据在文本协议中正确传输
- **编码开销**：约33%的数据增长，但保证传输可靠性

## 4. 消息系统设计

### 消息类型枚举

cpp

```cpp
enum MessageType {
    VIDEO_CALL_REQUEST = 54,  // 发起通话
    VIDEO_CALL_ACCEPT = 55,   // 接受通话
    VIDEO_DATA = 57,          // 视频帧数据
    // ...
}
```

- **状态机控制**：通过消息类型控制通话流程
- **协议扩展性**：枚举设计便于添加新功能

### 消息封装结构

cpp

```cpp
class Message {
    User *sender;        // 发送者信息
    User *receiver;      // 接收者信息
    QString content;     // 消息内容(Base64视频数据)
    MessageType type;    // 消息类型
}
```

## 5. 实时传输优化

### 帧率控制

cpp

```cpp
m_captureTimer->start(200);  // 5fps，每200ms一帧
```

- **平衡策略**：帧率vs数据量vs网络带宽
- **自适应调整**：根据网络状况动态调整

### 网络优化

cpp

```cpp
m_socket->flush();  // 强制立即发送
```

- **TCP缓冲区管理**：减少传输延迟
- **数据包优化**：每帧约2-3KB，适合局域网传输

## 6. 用户界面集成

### 异步显示更新

cpp

```cpp
// 主线程中更新UI
QPixmap pixmap = QPixmap::fromImage(image);
m_remoteImageLabel->setPixmap(pixmap.scaled(...));
```

- **线程安全**：确保UI更新在主线程执行
- **实时渲染**：QLabel自动处理图像缩放和显示

## 技术亮点总结

1. **混合架构**：Qt网络通信 + FFmpeg视频处理
2. **进程间通信**：QProcess管理外部FFmpeg进程
3. **协议设计**：自定义消息协议支持多媒体传输
4. **性能优化**：多级压缩、缓冲区管理、帧率控制
5. **跨平台兼容**：基于标准Linux V4L2接口

这个系统展示了如何将底层视频设备、网络编程、图像处理和用户界面有机结合，实现实时视频通信功能。